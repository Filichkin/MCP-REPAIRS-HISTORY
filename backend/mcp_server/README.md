# MCP Сервер истории ремонтов и обслуживания автомобилей

MCP (Model Context Protocol) сервер для получения информации об истории ремонтов, гарантийных обращений и технического обслуживания автомобилей по VIN номеру.

## Описание

Сервер предоставляет инструменты для работы с API истории ремонтов и обслуживания автомобилей. Все данные возвращаются на русском языке в структурированном формате.

## Доступные инструменты

### 1. `warranty_days(vin: str) -> str`

Получить статистику дней в ремонте по годам владения автомобиля.

**Параметры:**
- `vin` (str): VIN номер автомобиля

**Возвращает:**
Описание статистики ремонтов по годам владения на русском языке. Для каждого года указывается:
- Номер года владения
- Количество дней в ремонте
- Маркер текущего года (если применимо)

**Пример вывода:**
```
Для VIN XWEG3417BN0009095: год владения 1 - 15 дней в ремонте
Для VIN XWEG3417BN0009095: год владения 2 (текущий) - 8 дней в ремонте
```

---

### 2. `warranty_history(vin: str) -> str`

Получить историю гарантийных обращений автомобиля.

**Параметры:**
- `vin` (str): VIN номер автомобиля

**Возвращает:**
Подробное описание всех гарантийных обращений на русском языке. Для каждого обращения указывается:
- Номер гарантийного требования
- Дата открытия обращения
- Пробег на момент обращения
- Дилер (название и город)
- Деталь-виновник (номер и описание)
- Заменённые детали (каталожный номер и название)
- Выполненные работы (код операции и описание)

**Пример вывода:**
```
Гарантийное требование 12345 от 2025-10-01 (пробег 42284 км) у дилера ООО "Молоток Авто" (Москва).

Деталь-виновник: 76004Q5001. 
Описание детали-виновника: PANEL ASSY-FRONT DOOR,LH. 

Заменённые детали: 
Каталожный номер: 76004Q5001, Название: PANEL ASSY-FRONT DOOR,LH. 

Выполненные работы: 
Код операции: 76000R0B, Описание работы: FRONT DOOR PANEL ASSY, BOTH SIDES, R&R
```

---

### 3. `maintenance_history(vin: str) -> str`

Получить историю технического обслуживания автомобиля.

**Параметры:**
- `vin` (str): VIN номер автомобиля

**Возвращает:**
Описание всех записей технического обслуживания на русском языке. Для каждой записи указывается:
- VIN номер
- Тип обслуживания
- Дата обслуживания
- Пробег на момент обслуживания
- Дилер (название, код и город)

**Пример вывода:**
```
Для VIN XWEG3417BN0009095 проводилось ТО-1 2025-08-15 при пробеге 15000 км у дилера ООО "Молоток Авто", код 12345 в городе Москва
```

---

### 4. `vehicle_repairs_history(vin: str) -> str`

Получить историю ремонтов из дилерской сети (DNM records).

**Параметры:**
- `vin` (str): VIN номер автомобиля

**Возвращает:**
Описание всех ремонтов из дилерской сети на русском языке. Для каждого ремонта указывается:
- Название дилера
- Дата закрытия обращения
- Пробег на момент ремонта
- Тип ремонта
- Причина визита
- Рекомендации

**Пример вывода:**
```
Посещение ООО "Молоток Авто" 2025-10-01 (пробег 42284 км).

Тип ремонта: текущий ремонт.

Причина визита: замена двери по гарантии(КУЗОВНОЙ).

Рекомендации: Все работы выполнены в полном объеме.
```

---

## Запуск сервера

### Основной запуск

Для запуска MCP сервера выполните команду из директории `backend`:

```bash
python -m mcp_server.server
```

Сервер запустится на порту, указанном в конфигурации (по умолчанию `8004`), и будет доступен по адресу:
- **SSE endpoint:** `http://localhost:8004/sse`
- **Messages endpoint:** `http://localhost:8004/messages/`

При запуске сервер выведет информацию о:
- Адресе сервера
- Доступных эндпоинтах
- Списке доступных инструментов
- Настройках API

### Тестирование

Для тестирования работы сервера и всех инструментов используйте тестовый скрипт:

```bash
python -m mcp_server.test_server
```

Тестовый скрипт:
1. Подключается к запущенному MCP серверу
2. Проверяет доступность всех инструментов
3. Выполняет тестовые запросы для каждого инструмента с тестовым VIN номером
4. Выводит результаты выполнения

**Важно:** Перед запуском тестов убедитесь, что основной сервер запущен и доступен по адресу `http://localhost:8004/sse`.

---

## Конфигурация

Настройки сервера находятся в файле `backend/config.py` и могут быть переопределены через переменные окружения в файле `infra/.env`.

Основные параметры:
- `mcp_server_url` - URL MCP сервера (по умолчанию: `http://localhost:8004`)
- `mcp_transport` - тип транспорта (по умолчанию: `sse`)
- `mcp_server_port` - порт сервера (по умолчанию: `8004`)
- `mcp_server_host` - хост сервера (по умолчанию: `127.0.0.1`)
- `api_key` - Bearer токен для аутентификации в API
- `api_url` - URL внешнего API (по умолчанию: `http://127.0.0.1:8000`)

---

## Аутентификация

Сервер использует Bearer token аутентификацию для доступа к внешнему API. Токен должен быть указан в конфигурации через переменную `api_key`.

---

## Обработка ошибок

Сервер корректно обрабатывает следующие ситуации:
- **404 Not Found** - VIN не найден (логируется как INFO, возвращается пустой список или сообщение об отсутствии данных)
- **401 Unauthorized** - Ошибка аутентификации (логируется как ERROR)
- **Timeout** - Превышено время ожидания запроса (логируется как ERROR)
- **Другие HTTP ошибки** - Логируются как ERROR с указанием кода статуса

---

## Зависимости

Основные зависимости:
- `fastmcp` - фреймворк для создания MCP серверов
- `httpx` - асинхронный HTTP клиент
- `loguru` - логирование
- `pydantic-settings` - управление настройками

---

## Структура проекта

```
backend/
├── mcp_server/
│   ├── __init__.py
│   ├── server.py          # Основной файл сервера с инструментами
│   ├── test_server.py     # Тестовый скрипт
│   └── README.md          # Документация
├── config.py              # Конфигурация
└── pyproject.toml         # Зависимости проекта
```

